<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Locus | Silent Tracking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #09090b; color: #e4e4e7; }
        .glass-panel { 
            background: rgba(24, 24, 27, 0.85); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .map-container { height: 100vh; width: 100vw; z-index: 0; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }

        .leaflet-container { background: #09090b; }
        .leaflet-popup-content-wrapper { background: rgba(24, 24, 27, 0.9); color: #e4e4e7; border: 1px solid #3f3f46; border-radius: 8px; }
        .leaflet-popup-tip { background: rgba(24, 24, 27, 0.9); }

        /* Hide zoom control on mobile */
        @media (max-width: 768px) {
            .leaflet-control-zoom { display: none; }
        }

        /* Animated path effect */
        .animated-path {
            stroke-dasharray: 10, 10;
            animation: dash 1s linear infinite;
        }
        @keyframes dash {
            to { stroke-dashoffset: -20; }
        }

        /* Alert pulse animation */
        @keyframes alertPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .alert-pulse { animation: alertPulse 2s ease-in-out infinite; }
    </style>
</head>
<body class="overflow-hidden">

    <!-- Map Background -->
    <div id="map" class="map-container absolute top-0 left-0"></div>

    <!-- Alert Bell Button -->
    <button id="alert-bell" onclick="toggleAlertPanel()" class="fixed top-4 right-4 md:top-4 md:right-96 w-12 h-12 glass-panel rounded-full flex items-center justify-center z-[1001] hover:bg-white/10 transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
        </svg>
        <span id="alert-badge" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center hidden">0</span>
    </button>

    <!-- Alert Panel -->
    <div id="alert-panel" class="fixed top-20 right-4 w-80 max-h-[70vh] glass-panel rounded-2xl shadow-2xl z-[1001] hidden transition-all duration-300 opacity-0 translate-y-2">
        <div class="p-4 border-b border-white/10 flex justify-between items-center">
            <h2 class="text-sm font-medium text-zinc-200">üö® Alerts</h2>
            <button onclick="markAllAlertsRead()" class="text-[10px] text-zinc-500 hover:text-zinc-300">Mark all read</button>
        </div>
        <div id="alert-list" class="overflow-y-auto max-h-[50vh] p-3 space-y-2">
            <div class="text-center text-zinc-600 text-xs py-8">No alerts</div>
        </div>
    </div>

    <!-- Floating Sidebar -->
    <aside class="fixed md:absolute bottom-0 md:bottom-4 left-0 md:left-4 w-full md:w-80 h-[40vh] md:h-auto md:top-4 glass-panel rounded-t-2xl md:rounded-2xl flex flex-col shadow-2xl z-[1000] transition-transform duration-300 transform translate-x-0">
        <!-- Mobile Drag Handle (Visual Only) -->
        <div class="md:hidden w-full flex justify-center pt-3 pb-1">
            <div class="w-12 h-1.5 rounded-full bg-zinc-700/50"></div>
        </div>
        
        <!-- Header -->
        <div class="p-4 md:p-6 border-b border-white/10">
            <div class="flex items-center gap-3 mb-1">
                <div class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]"></div>
                <h1 class="text-xl font-medium tracking-tight text-white">LOCUS</h1>
            </div>
            <p class="text-xs text-zinc-500 font-light">Silent Session Tracker</p>
        </div>

        <!-- Session List -->
        <div class="flex-1 overflow-y-auto p-3 space-y-2" id="sessions-list">
            <!-- Loading State -->
            <div class="flex flex-col items-center justify-center h-32 text-zinc-600 space-y-2">
                <div class="w-4 h-4 border-2 border-zinc-600 border-t-transparent rounded-full animate-spin"></div>
                <span class="text-xs">Loading sessions...</span>
            </div>
        </div>

        <!-- Footer -->
        <div class="p-4 border-t border-white/10 text-[10px] text-zinc-600 text-center">
            Auto-syncing every 20s
        </div>
    </aside>

    <!-- Floating Info Panel (Hidden by default) -->
    <div id="session-info" class="fixed md:absolute top-4 left-4 right-4 md:left-auto md:right-4 w-auto md:w-80 glass-panel rounded-2xl p-4 md:p-6 shadow-2xl z-[1000] hidden transition-all duration-300 opacity-0 translate-y-2 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-start mb-4 md:mb-6">
            <div>
                <h2 class="text-sm font-medium text-zinc-400 uppercase tracking-wider">Session Details</h2>
                <div id="info-id" class="text-xs font-mono text-zinc-600 mt-1"></div>
            </div>
            <div id="info-status-badge" class="w-2 h-2 rounded-full bg-zinc-700"></div>
        </div>

        <div class="space-y-4">
            <div class="flex justify-between items-center">
                <span class="text-xs text-zinc-500">Device</span>
                <span id="info-device" class="text-sm font-medium text-zinc-200"></span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-xs text-zinc-500">Data Points</span>
                <span id="info-points" class="text-sm font-mono text-emerald-400">0</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-xs text-zinc-500">Last Update</span>
                <span id="info-last" class="text-xs text-zinc-300"></span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-xs text-zinc-500">Duration</span>
                <span id="info-duration" class="text-xs text-zinc-300"></span>
            </div>
        </div>

        <!-- Statistics Section -->
        <div class="mt-6 pt-4 border-t border-white/10">
            <h3 class="text-xs font-medium text-zinc-400 uppercase tracking-wider mb-3">Statistics</h3>
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white/5 rounded-xl p-3 text-center">
                    <div id="stat-distance" class="text-lg font-medium text-emerald-400">-</div>
                    <div class="text-[10px] text-zinc-500">Distance (km)</div>
                </div>
                <div class="bg-white/5 rounded-xl p-3 text-center">
                    <div id="stat-avg-speed" class="text-lg font-medium text-blue-400">-</div>
                    <div class="text-[10px] text-zinc-500">Avg Speed (km/h)</div>
                </div>
                <div class="bg-white/5 rounded-xl p-3 text-center">
                    <div id="stat-max-speed" class="text-lg font-medium text-orange-400">-</div>
                    <div class="text-[10px] text-zinc-500">Max Speed (km/h)</div>
                </div>
                <div class="bg-white/5 rounded-xl p-3 text-center">
                    <div id="stat-accuracy" class="text-lg font-medium text-purple-400">-</div>
                    <div class="text-[10px] text-zinc-500">Avg Accuracy (m)</div>
                </div>
            </div>
        </div>

        <!-- View Mode Toggle -->
        <div class="mt-4 flex gap-2">
            <button onclick="setViewMode('path')" id="btn-path" class="flex-1 py-2 px-3 text-[10px] font-medium rounded-lg bg-emerald-500/20 text-emerald-400 border border-emerald-500/30">
                Path
            </button>
            <button onclick="setViewMode('heatmap')" id="btn-heatmap" class="flex-1 py-2 px-3 text-[10px] font-medium rounded-lg bg-white/5 text-zinc-400 border border-white/10 hover:bg-white/10">
                Heatmap
            </button>
            <button onclick="setViewMode('speed')" id="btn-speed" class="flex-1 py-2 px-3 text-[10px] font-medium rounded-lg bg-white/5 text-zinc-400 border border-white/10 hover:bg-white/10">
                Speed
            </button>
        </div>

        <!-- Playback Controls -->
        <div class="mt-4 pt-4 border-t border-white/10">
            <h3 class="text-xs font-medium text-zinc-400 uppercase tracking-wider mb-3">Playback</h3>
            <div class="flex items-center gap-2 mb-2">
                <button onclick="togglePlayback()" id="playback-btn" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition-all">
                    <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                </button>
                <input type="range" id="playback-slider" min="0" max="100" value="0" class="flex-1 h-1 bg-zinc-700 rounded-lg appearance-none cursor-pointer" onchange="seekPlayback(this.value)">
                <span id="playback-time" class="text-[10px] text-zinc-500 w-16 text-right">00:00</span>
            </div>
            <div class="flex gap-2">
                <button onclick="setPlaybackSpeed(0.5)" class="text-[10px] px-2 py-1 rounded bg-white/5 text-zinc-400 hover:bg-white/10">0.5x</button>
                <button onclick="setPlaybackSpeed(1)" class="text-[10px] px-2 py-1 rounded bg-white/10 text-zinc-300">1x</button>
                <button onclick="setPlaybackSpeed(2)" class="text-[10px] px-2 py-1 rounded bg-white/5 text-zinc-400 hover:bg-white/10">2x</button>
                <button onclick="setPlaybackSpeed(5)" class="text-[10px] px-2 py-1 rounded bg-white/5 text-zinc-400 hover:bg-white/10">5x</button>
            </div>
        </div>

        <!-- Export Section -->
        <div class="mt-4 pt-4 border-t border-white/10">
            <h3 class="text-xs font-medium text-zinc-400 uppercase tracking-wider mb-3">Export Data</h3>
            <div class="flex gap-2">
                <button onclick="exportCSV()" class="flex-1 py-2 px-3 text-xs font-medium rounded-lg bg-white/5 text-zinc-300 border border-white/10 hover:bg-white/10 transition-all">
                    üìÑ CSV
                </button>
                <button onclick="exportGPX()" class="flex-1 py-2 px-3 text-xs font-medium rounded-lg bg-white/5 text-zinc-300 border border-white/10 hover:bg-white/10 transition-all">
                    üó∫Ô∏è GPX
                </button>
            </div>
        </div>
    </div>

    <script>
        // Map Config
        const map = L.map('map', {
            zoomControl: false,
            attributionControl: false
        }).setView([20, 0], 2);

        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // Dark Matter Tile Layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 20,
            subdomains: 'abcd'
        }).addTo(map);

        let currentPolyline = null;
        let currentPolylineBg = null;
        let currentMarkers = [];
        let currentHeatLayer = null;
        let speedPolylines = [];
        let activeSessionId = null;
        let refreshInterval = null;
        let currentLocations = [];
        let viewMode = 'path'; // 'path', 'heatmap', 'speed'
        
        // Playback state
        let playbackMarker = null;
        let isPlaying = false;
        let playbackIndex = 0;
        let playbackSpeed = 1;
        let playbackInterval = null;

        // Fetch Sessions
        async function fetchSessions() {
            try {
                const res = await fetch('/api/sessions');
                const sessions = await res.json();
                renderSessions(sessions);
            } catch (err) {
                console.error('Error fetching sessions:', err);
            }
        }

        function renderSessions(sessions) {
            const container = document.getElementById('sessions-list');
            container.innerHTML = '';

            if (sessions.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-zinc-600">
                        <span class="text-xs">No active sessions</span>
                    </div>`;
                return;
            }

            sessions.forEach(session => {
                // Parse timestamps - handle both integer and string formats
                const startTimeMs = parseInt(session.startTime) || new Date(session.startTime).getTime();
                const endTimeMs = parseInt(session.endTime) || new Date(session.endTime).getTime();
                
                const isActive = session.isActive === 1 && Date.now() < endTimeMs;
                const el = document.createElement('div');
                const isSelected = activeSessionId === session.id;
                
                el.className = `group p-4 rounded-xl cursor-pointer transition-all duration-200 border ${isSelected ? 'bg-white/5 border-emerald-500/30 shadow-lg' : 'bg-transparent border-transparent hover:bg-white/5 hover:border-white/5'}`;
                el.onclick = () => loadSession({...session, startTimeMs, endTimeMs});
                
                const startTime = new Date(startTimeMs);
                const timeStr = startTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const dateStr = startTime.toLocaleDateString([], { month: 'short', day: 'numeric' });

                el.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-mono text-[10px] text-zinc-500 group-hover:text-zinc-400 transition-colors">${session.id.split('-')[0]}</span>
                        ${isActive 
                            ? '<span class="flex h-1.5 w-1.5 relative"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-emerald-500"></span></span>' 
                            : '<span class="h-1.5 w-1.5 rounded-full bg-zinc-700"></span>'}
                    </div>
                    <div class="flex justify-between items-end">
                        <div>
                            <div class="text-sm font-medium text-zinc-200 mb-0.5">${session.deviceId}</div>
                            <div class="text-[10px] text-zinc-500">${dateStr} ‚Ä¢ ${timeStr}</div>
                        </div>
                        <div class="text-[10px] text-zinc-600 group-hover:text-zinc-500 transition-colors">
                            ${isActive ? 'Tracking' : 'Ended'}
                        </div>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        async function loadSession(session) {
            activeSessionId = session.id;
            fetchSessions(); // Re-render list to update selection state
            
            // Show Info Panel
            const infoPanel = document.getElementById('session-info');
            infoPanel.classList.remove('hidden');
            // Small delay to allow display:block to apply before opacity transition
            setTimeout(() => {
                infoPanel.classList.remove('opacity-0', 'translate-y-2');
            }, 10);

            document.getElementById('info-id').textContent = session.id;
            document.getElementById('info-device').textContent = session.deviceId;
            
            // Use pre-parsed timestamps
            const startTimeMs = session.startTimeMs || parseInt(session.startTime) || new Date(session.startTime).getTime();
            const endTimeMs = session.endTimeMs || parseInt(session.endTime) || new Date(session.endTime).getTime();
            
            const isActive = session.isActive === 1 && Date.now() < endTimeMs;
            const badge = document.getElementById('info-status-badge');
            badge.className = `w-2 h-2 rounded-full ${isActive ? 'bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.6)]' : 'bg-red-500'}`;

            // Calculate Duration
            const start = new Date(startTimeMs);
            const end = isActive ? new Date() : new Date(endTimeMs);
            const diffHrs = ((end - start) / 36e5).toFixed(1);
            document.getElementById('info-duration').textContent = `${diffHrs} hrs`;

            // Clear map
            clearMapLayers();
            
            // Stop any playback
            stopPlayback();

            await updateMapData(session.id);
            await fetchSessionStats(session.id);

            // Start polling if active
            if (refreshInterval) clearInterval(refreshInterval);
            if (isActive) {
                refreshInterval = setInterval(() => updateMapData(session.id), 20000);
            }
        }
        
        function clearMapLayers() {
            if (currentPolyline) map.removeLayer(currentPolyline);
            if (currentPolylineBg) map.removeLayer(currentPolylineBg);
            if (currentHeatLayer) map.removeLayer(currentHeatLayer);
            speedPolylines.forEach(p => map.removeLayer(p));
            speedPolylines = [];
            currentMarkers.forEach(m => map.removeLayer(m));
            currentMarkers = [];
            if (playbackMarker) map.removeLayer(playbackMarker);
            playbackMarker = null;
        }
        
        async function fetchSessionStats(sessionId) {
            try {
                const res = await fetch(`/api/session/${sessionId}/stats`);
                const stats = await res.json();
                
                document.getElementById('stat-distance').textContent = stats.totalDistanceKm || '-';
                document.getElementById('stat-avg-speed').textContent = stats.avgSpeedKmh || '-';
                document.getElementById('stat-max-speed').textContent = stats.maxSpeedKmh || '-';
                document.getElementById('stat-accuracy').textContent = stats.avgAccuracyM || '-';
            } catch (err) {
                console.error('Error fetching stats:', err);
            }
        }

        async function updateMapData(sessionId) {
            try {
                const res = await fetch(`/api/session/${sessionId}/locations`);
                currentLocations = await res.json();
                
                document.getElementById('info-points').textContent = currentLocations.length;
                if (currentLocations.length > 0) {
                    const lastLoc = currentLocations[currentLocations.length - 1];
                    const lastTimestamp = parseInt(lastLoc.timestamp) || new Date(lastLoc.timestamp).getTime();
                    document.getElementById('info-last').textContent = new Date(lastTimestamp).toLocaleTimeString();
                } else {
                    document.getElementById('info-last').textContent = '-';
                }
                
                // Update playback slider max
                document.getElementById('playback-slider').max = Math.max(0, currentLocations.length - 1);

                // Render based on view mode
                renderMapView();
            } catch (err) {
                console.error('Error fetching locations:', err);
            }
        }
        
        function renderMapView() {
            clearMapLayers();
            
            if (currentLocations.length === 0) return;
            
            const latlngs = currentLocations.map(loc => [loc.latitude, loc.longitude]);
            
            if (viewMode === 'path') {
                renderPathView(latlngs);
            } else if (viewMode === 'heatmap') {
                renderHeatmapView();
            } else if (viewMode === 'speed') {
                renderSpeedView();
            }
            
            // Fit map to show entire path
            if (latlngs.length > 1) {
                const bounds = L.latLngBounds(latlngs);
                map.fitBounds(bounds, { padding: [50, 50] });
            }
            
            // Add start/end markers
            addMarkers(latlngs);
        }
        
        function renderPathView(latlngs) {
            // Background glow line
            currentPolylineBg = L.polyline(latlngs, { 
                color: '#10b981',
                weight: 8, 
                opacity: 0.2,
                lineCap: 'round',
                lineJoin: 'round'
            }).addTo(map);

            // Main path line
            currentPolyline = L.polyline(latlngs, { 
                color: '#10b981',
                weight: 3, 
                opacity: 0.9,
                lineCap: 'round',
                lineJoin: 'round',
                className: 'animated-path'
            }).addTo(map);
        }
        
        function renderHeatmapView() {
            const heatData = currentLocations.map(loc => [loc.latitude, loc.longitude, 0.5]);
            currentHeatLayer = L.heatLayer(heatData, {
                radius: 25,
                blur: 15,
                maxZoom: 17,
                gradient: {
                    0.0: '#09090b',
                    0.2: '#10b981',
                    0.4: '#3b82f6',
                    0.6: '#f59e0b',
                    0.8: '#ef4444',
                    1.0: '#ffffff'
                }
            }).addTo(map);
        }
        
        function renderSpeedView() {
            // Color-code path segments by speed
            for (let i = 1; i < currentLocations.length; i++) {
                const prev = currentLocations[i - 1];
                const curr = currentLocations[i];
                const speedKmh = (curr.speed || 0) * 3.6;
                
                const color = getSpeedColor(speedKmh);
                
                const segment = L.polyline([
                    [prev.latitude, prev.longitude],
                    [curr.latitude, curr.longitude]
                ], {
                    color: color,
                    weight: 4,
                    opacity: 0.9,
                    lineCap: 'round',
                    lineJoin: 'round'
                }).addTo(map);
                
                // Add popup with speed info
                segment.bindPopup(`<div class="text-sm"><strong>${speedKmh.toFixed(1)} km/h</strong></div>`);
                
                speedPolylines.push(segment);
            }
            
            // Add legend
            addSpeedLegend();
        }
        
        function getSpeedColor(speedKmh) {
            if (speedKmh < 5) return '#10b981';  // Green - stationary/walking
            if (speedKmh < 20) return '#3b82f6'; // Blue - cycling
            if (speedKmh < 50) return '#f59e0b'; // Orange - city driving
            if (speedKmh < 100) return '#ef4444'; // Red - highway
            return '#ec4899'; // Pink - very fast
        }
        
        function addSpeedLegend() {
            // Remove existing legend if any
            const existingLegend = document.querySelector('.speed-legend');
            if (existingLegend) existingLegend.remove();
            
            const legend = L.control({ position: 'bottomleft' });
            legend.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'speed-legend glass-panel p-3 rounded-xl');
                div.innerHTML = `
                    <div class="text-[10px] text-zinc-400 mb-2 font-medium">SPEED (km/h)</div>
                    <div class="flex flex-col gap-1 text-[10px]">
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded" style="background:#10b981"></span> <5 (Walk)</div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded" style="background:#3b82f6"></span> 5-20 (Cycle)</div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded" style="background:#f59e0b"></span> 20-50 (City)</div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded" style="background:#ef4444"></span> 50-100 (Highway)</div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded" style="background:#ec4899"></span> >100 (Fast)</div>
                    </div>
                `;
                return div;
            };
            legend.addTo(map);
        }
        
        function addMarkers(latlngs) {
            if (latlngs.length === 0) return;
            
            // Start Marker
            const startIcon = L.divIcon({
                className: 'bg-transparent',
                html: '<div class="w-3 h-3 bg-white rounded-full border-2 border-emerald-500 shadow-lg"></div>'
            });
            currentMarkers.push(L.marker(latlngs[0], { icon: startIcon }).addTo(map));

            // End/Current Marker
            const endIcon = L.divIcon({
                className: 'bg-transparent',
                html: '<div class="w-4 h-4 bg-emerald-500 rounded-full border-2 border-white shadow-[0_0_15px_rgba(16,185,129,0.6)] animate-pulse"></div>'
            });
            currentMarkers.push(L.marker(latlngs[latlngs.length - 1], { icon: endIcon }).addTo(map));
        }
        
        function setViewMode(mode) {
            viewMode = mode;
            
            // Update button styles
            ['path', 'heatmap', 'speed'].forEach(m => {
                const btn = document.getElementById(`btn-${m}`);
                if (m === mode) {
                    btn.className = 'flex-1 py-2 px-3 text-[10px] font-medium rounded-lg bg-emerald-500/20 text-emerald-400 border border-emerald-500/30';
                } else {
                    btn.className = 'flex-1 py-2 px-3 text-[10px] font-medium rounded-lg bg-white/5 text-zinc-400 border border-white/10 hover:bg-white/10';
                }
            });
            
            // Remove speed legend if not in speed mode
            if (mode !== 'speed') {
                const legend = document.querySelector('.speed-legend');
                if (legend) legend.remove();
            }
            
            renderMapView();
        }
        
        // ========== PLAYBACK FUNCTIONS ==========
        
        function togglePlayback() {
            if (isPlaying) {
                stopPlayback();
            } else {
                startPlayback();
            }
        }
        
        function startPlayback() {
            if (currentLocations.length === 0) return;
            
            isPlaying = true;
            updatePlayIcon();
            
            // Create playback marker if not exists
            if (!playbackMarker) {
                const playIcon = L.divIcon({
                    className: 'bg-transparent',
                    html: '<div class="w-6 h-6 bg-blue-500 rounded-full border-3 border-white shadow-[0_0_20px_rgba(59,130,246,0.8)] flex items-center justify-center"><div class="w-2 h-2 bg-white rounded-full"></div></div>'
                });
                playbackMarker = L.marker([currentLocations[0].latitude, currentLocations[0].longitude], { 
                    icon: playIcon,
                    zIndexOffset: 1000
                }).addTo(map);
            }
            
            playbackInterval = setInterval(() => {
                if (playbackIndex >= currentLocations.length - 1) {
                    stopPlayback();
                    return;
                }
                
                playbackIndex++;
                updatePlaybackPosition();
            }, 500 / playbackSpeed);
        }
        
        function stopPlayback() {
            isPlaying = false;
            updatePlayIcon();
            if (playbackInterval) {
                clearInterval(playbackInterval);
                playbackInterval = null;
            }
        }
        
        function updatePlayIcon() {
            const icon = document.getElementById('play-icon');
            if (isPlaying) {
                icon.innerHTML = '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>';
            } else {
                icon.innerHTML = '<path d="M8 5v14l11-7z"/>';
            }
        }
        
        function updatePlaybackPosition() {
            if (!playbackMarker || currentLocations.length === 0) return;
            
            const loc = currentLocations[playbackIndex];
            playbackMarker.setLatLng([loc.latitude, loc.longitude]);
            
            // Update slider
            document.getElementById('playback-slider').value = playbackIndex;
            
            // Update time display
            const timestamp = parseInt(loc.timestamp) || new Date(loc.timestamp).getTime();
            document.getElementById('playback-time').textContent = new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Center map on marker
            map.panTo([loc.latitude, loc.longitude], { animate: true, duration: 0.3 });
        }
        
        function seekPlayback(value) {
            playbackIndex = parseInt(value);
            
            if (!playbackMarker && currentLocations.length > 0) {
                const playIcon = L.divIcon({
                    className: 'bg-transparent',
                    html: '<div class="w-6 h-6 bg-blue-500 rounded-full border-3 border-white shadow-[0_0_20px_rgba(59,130,246,0.8)] flex items-center justify-center"><div class="w-2 h-2 bg-white rounded-full"></div></div>'
                });
                playbackMarker = L.marker([currentLocations[0].latitude, currentLocations[0].longitude], { 
                    icon: playIcon,
                    zIndexOffset: 1000
                }).addTo(map);
            }
            
            updatePlaybackPosition();
        }
        
        function setPlaybackSpeed(speed) {
            playbackSpeed = speed;
            
            // Update button styles
            document.querySelectorAll('[onclick^="setPlaybackSpeed"]').forEach(btn => {
                const btnSpeed = parseFloat(btn.textContent);
                if (btnSpeed === speed) {
                    btn.className = 'text-[10px] px-2 py-1 rounded bg-white/10 text-zinc-300';
                } else {
                    btn.className = 'text-[10px] px-2 py-1 rounded bg-white/5 text-zinc-400 hover:bg-white/10';
                }
            });
            
            // Restart playback with new speed if playing
            if (isPlaying) {
                stopPlayback();
                startPlayback();
            }
        }
        
        // ========== EXPORT FUNCTIONS ==========
        
        function exportCSV() {
            if (!activeSessionId) return;
            window.open(`/api/session/${activeSessionId}/export/csv`, '_blank');
        }
        
        function exportGPX() {
            if (!activeSessionId) return;
            window.open(`/api/session/${activeSessionId}/export/gpx`, '_blank');
        }

        // Initial Load
        fetchSessions();
        setInterval(fetchSessions, 20000); // Refresh list every 20s

        // ========== ALERTS SYSTEM ==========
        let alertPanelOpen = false;

        async function fetchAlerts() {
            try {
                const res = await fetch('/api/alerts');
                const alerts = await res.json();
                renderAlerts(alerts);
                
                // Update badge
                const unreadCount = alerts.filter(a => a.isRead === 0).length;
                updateAlertBadge(unreadCount);
            } catch (err) {
                console.error('Error fetching alerts:', err);
            }
        }

        function updateAlertBadge(count) {
            const badge = document.getElementById('alert-badge');
            const bell = document.getElementById('alert-bell');
            
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.classList.remove('hidden');
                bell.classList.add('alert-pulse');
            } else {
                badge.classList.add('hidden');
                bell.classList.remove('alert-pulse');
            }
        }

        function renderAlerts(alerts) {
            const container = document.getElementById('alert-list');
            
            if (alerts.length === 0) {
                container.innerHTML = '<div class="text-center text-zinc-600 text-xs py-8">No alerts</div>';
                return;
            }

            container.innerHTML = alerts.map(alert => {
                const timestamp = parseInt(alert.timestamp) || new Date(alert.timestamp).getTime();
                const timeAgo = getTimeAgo(timestamp);
                const isUnread = alert.isRead === 0;
                
                const typeConfig = {
                    'GEOFENCE_ENTERED': { icon: 'üìç', color: 'text-red-400', bg: 'bg-red-500/10' },
                    'CONNECTIVITY_LOST': { icon: 'üì°', color: 'text-yellow-400', bg: 'bg-yellow-500/10' },
                };
                const config = typeConfig[alert.type] || { icon: '‚ö†Ô∏è', color: 'text-zinc-400', bg: 'bg-zinc-500/10' };

                return `
                    <div class="p-3 rounded-xl ${config.bg} ${isUnread ? 'border border-white/10' : 'opacity-60'}" onclick="markAlertRead(${alert.id})">
                        <div class="flex items-start gap-3">
                            <span class="text-lg">${config.icon}</span>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="text-xs font-medium ${config.color}">${alert.type.replace('_', ' ')}</span>
                                    ${isUnread ? '<span class="w-2 h-2 bg-red-500 rounded-full"></span>' : ''}
                                </div>
                                <p class="text-xs text-zinc-300 mb-1">${alert.message}</p>
                                <div class="flex justify-between items-center">
                                    <span class="text-[10px] text-zinc-500">${alert.deviceId || 'Unknown'}</span>
                                    <span class="text-[10px] text-zinc-600">${timeAgo}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        function toggleAlertPanel() {
            const panel = document.getElementById('alert-panel');
            alertPanelOpen = !alertPanelOpen;
            
            if (alertPanelOpen) {
                panel.classList.remove('hidden');
                setTimeout(() => {
                    panel.classList.remove('opacity-0', 'translate-y-2');
                }, 10);
                fetchAlerts();
            } else {
                panel.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => {
                    panel.classList.add('hidden');
                }, 300);
            }
        }

        async function markAlertRead(alertId) {
            try {
                await fetch(`/api/alert/${alertId}/read`, { method: 'POST' });
                fetchAlerts();
            } catch (err) {
                console.error('Error marking alert read:', err);
            }
        }

        async function markAllAlertsRead() {
            try {
                await fetch('/api/alerts/read-all', { method: 'POST' });
                fetchAlerts();
            } catch (err) {
                console.error('Error marking all alerts read:', err);
            }
        }

        // Fetch alerts on load and periodically
        fetchAlerts();
        setInterval(fetchAlerts, 10000); // Check alerts every 10s

    </script>
</body>
</html>
